<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Admin V2)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Sarabun', sans-serif; }
    .hidden { display: none !important; }
    /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ü‡∏≠‡∏£‡πå‡∏° */
    .input-group label { display: block; font-weight: bold; margin-bottom: 5px; color: #1e3a8a; }
    .input-group input, .input-group select { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; }
    .section-head { background: #e0f2fe; padding: 10px; font-weight: bold; color: #0c4a6e; border-left: 4px solid #0284c7; margin-top: 20px; margin-bottom: 10px; }
    /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÅ‡∏ó‡πá‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô */
    .tab-btn { padding: 10px 20px; font-weight: bold; cursor: pointer; border-bottom: 3px solid transparent; }
    .tab-btn.active { border-bottom-color: #1e3a8a; color: #1e3a8a; }
  </style>
</head>
<body class="bg-gray-100">

  <div id="loginSection" class="min-h-screen flex flex-col md:flex-row">
    <div class="md:w-1/2 bg-blue-900 flex flex-col justify-center items-center text-white p-10 relative">
      <h1 class="text-4xl font-bold mb-4">‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
      <h2 class="text-2xl opacity-90">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡∏≤‡∏á‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</h2>
      <div class="mt-8 text-center text-blue-200"><p>‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p></div>
      <button onclick="toggleAdminLogin()" class="absolute bottom-4 left-4 text-blue-400 text-xs hover:text-white">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</button>
    </div>
    
    <div class="md:w-1/2 bg-white flex flex-col justify-center items-center p-8">
      <div class="w-full max-w-md">
        <div id="studentLoginBox">
          <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö (‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)</h3>
          <form onsubmit="handleLogin(event, 'student')" class="space-y-4">
            <input type="text" id="loginIdCard" maxlength="13" required class="w-full p-4 border rounded-lg text-xl text-center tracking-widest" placeholder="‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£ 13 ‡∏´‡∏•‡∏±‡∏Å">
            <button type="submit" id="btnLoginStudent" class="w-full bg-blue-900 text-white py-4 rounded-lg font-bold text-lg hover:bg-blue-800">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</button>
          </form>
        </div>
        <div id="adminLoginBox" class="hidden">
          <h3 class="text-2xl font-bold text-red-800 mb-6 text-center">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö (‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà)</h3>
          <form onsubmit="handleLogin(event, 'admin')" class="space-y-4">
            <input type="password" id="adminPass" required class="w-full p-3 border rounded" placeholder="Password">
            <button type="submit" id="btnLoginAdmin" class="w-full bg-red-800 text-white py-3 rounded-lg font-bold hover:bg-red-700">Login</button>
            <button type="button" onclick="toggleAdminLogin()" class="w-full text-gray-500 mt-2 text-sm">‡∏Å‡∏•‡∏±‡∏ö</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div id="adminSection" class="hidden min-h-screen bg-gray-100 p-6">
    <div class="max-w-6xl mx-auto bg-white rounded-xl shadow-xl overflow-hidden">
      <div class="bg-gray-800 text-white p-4 flex justify-between items-center">
        <h2 class="text-xl font-bold">Admin Dashboard</h2>
        <button onclick="location.reload()" class="bg-red-600 px-3 py-1 rounded text-sm hover:bg-red-700">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>

      <div class="flex border-b">
        <div onclick="switchTab('applicants')" id="tab-applicants" class="tab-btn active">üìÑ ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£</div>
        <div onclick="switchTab('whitelist')" id="tab-whitelist" class="tab-btn text-gray-500">‚öôÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (Whitelist)</div>
      </div>

      <div id="view-applicants" class="p-6">
        <h3 class="font-bold text-lg mb-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
        <div class="overflow-x-auto">
          <table class="w-full text-left border-collapse border">
            <thead class="bg-gray-100">
              <tr><th class="p-2 border">‡πÄ‡∏ß‡∏•‡∏≤</th><th class="p-2 border">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£</th><th class="p-2 border">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th><th class="p-2 border">PDF</th></tr>
            </thead>
            <tbody id="adminTableBody"></tbody>
          </table>
        </div>
      </div>

      <div id="view-whitelist" class="p-6 hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          
          <div>
            <h3 class="font-bold text-lg mb-2 text-blue-800">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</h3>
            <p class="text-sm text-gray-600 mb-2">‡∏Å‡πä‡∏≠‡∏õ‡∏õ‡∏µ‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Excel (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå A=‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£, B=‡∏ä‡∏∑‡πà‡∏≠) ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
            <textarea id="whitelistInput" class="w-full h-64 p-3 border rounded font-mono text-sm bg-gray-50" placeholder="1234567890123	‡∏î.‡∏ä.‡∏£‡∏±‡∏Å‡∏î‡∏µ ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏Å‡πà‡∏á&#10;9876543210987	‡∏î.‡∏ç.‡∏°‡∏≤‡∏ô‡∏∞ ‡∏≠‡∏î‡∏ó‡∏ô"></textarea>
            <div class="flex gap-2 mt-2">
              <button onclick="saveWhitelist()" id="btnSaveWhitelist" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°</button>
              <button onclick="document.getElementById('whitelistInput').value=''" class="bg-gray-300 px-4 py-2 rounded">‡∏•‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á</button>
            </div>
          </div>

          <div class="bg-gray-50 p-4 rounded border">
            <h3 class="font-bold text-lg mb-2">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h3>
            <div class="overflow-y-auto h-64 bg-white border rounded">
              <table class="w-full text-sm">
                <thead class="bg-gray-200 sticky top-0">
                  <tr><th class="p-2">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£</th><th class="p-2">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th></tr>
                </thead>
                <tbody id="whitelistTableBody">
                  <tr><td colspan="2" class="p-4 text-center text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
                </tbody>
              </table>
            </div>
            <p class="text-right text-xs text-gray-500 mt-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span id="whitelistCount">0</span> ‡∏Ñ‡∏ô</p>
          </div>

        </div>
      </div>
    </div>
  </div>

  <div id="formSection" class="hidden p-4 md:p-8 max-w-5xl mx-auto">
     <div class="bg-white p-10 rounded shadow-lg text-center">
        <h2 class="text-2xl font-bold mb-4">‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</h2>
        <p class="text-gray-500">(‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà)</p>
        <form id="appForm" onsubmit="submitForm(event)">
           <input type="hidden" id="idCard">
           <button type="submit" id="btnSubmit" class="bg-blue-900 text-white px-6 py-2 rounded mt-4">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button>
        </form>
     </div>
  </div>

  <script>
    // üî¥üî¥üî¥ URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì üî¥üî¥üî¥
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxtWZwXSFcbdrrPZSLrs4kmEDYB4fqx3MxUs0Wo40lgkAyIi_6C-j0AJ3YZgWOBJ16AHw/exec'; 

    let currentWhitelist = [];

    function toggleAdminLogin() {
      document.getElementById('studentLoginBox').classList.toggle('hidden');
      document.getElementById('adminLoginBox').classList.toggle('hidden');
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('view-applicants').classList.add('hidden');
      document.getElementById('view-whitelist').classList.add('hidden');
      
      document.getElementById('tab-' + tab).classList.add('active');
      document.getElementById('view-' + tab).classList.remove('hidden');
    }

    function handleLogin(e, role) {
      e.preventDefault();
      let payload = { action: 'login' };
      let btn;

      if (role === 'student') {
        payload.idCard = document.getElementById('loginIdCard').value;
        btn = document.getElementById('btnLoginStudent');
      } else {
        payload.idCard = 'admin';
        payload.password = document.getElementById('adminPass').value;
        btn = document.getElementById('btnLoginAdmin');
      }
      
      btn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...'; btn.disabled = true;

      fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) })
      .then(res => res.json())
      .then(json => {
         if (json.error) { alert('‚ùå ' + json.error); return; }
         
         document.getElementById('loginSection').classList.add('hidden');
         
         if (json.role === 'admin') {
            document.getElementById('adminSection').classList.remove('hidden');
            renderApplicants(json.data);
            renderWhitelist(json.whitelist); // ‡πÅ‡∏™‡∏î‡∏á Whitelist ‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤
         } else {
            document.getElementById('formSection').classList.remove('hidden');
            document.getElementById('idCard').value = payload.idCard;
            if(json.found) { alert('‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°'); /* ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô populateForm(json.data) */ }
         }
      })
      .catch(err => alert('Error: ' + err))
      .finally(() => { btn.innerText = (role==='student'?'‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå':'Login'); btn.disabled = false; });
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Whitelist
    function renderWhitelist(list) {
      currentWhitelist = list || [];
      const tbody = document.getElementById('whitelistTableBody');
      document.getElementById('whitelistCount').innerText = currentWhitelist.length;
      tbody.innerHTML = '';
      
      if(currentWhitelist.length === 0) {
        tbody.innerHTML = '<tr><td colspan="2" class="p-2 text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>'; return;
      }
      
      currentWhitelist.forEach(item => {
        tbody.innerHTML += `<tr class="border-b"><td class="p-2 font-mono">${item.id}</td><td class="p-2">${item.name}</td></tr>`;
      });
    }

    function saveWhitelist() {
      const text = document.getElementById('whitelistInput').value;
      if(!text.trim()) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô'); return; }

      const lines = text.trim().split('\n');
      const newList = [];
      
      // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏á (‡πÅ‡∏¢‡∏Å‡∏î‡πâ‡∏ß‡∏¢ Tab ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏£‡∏£‡∏Ñ)
      lines.forEach(line => {
         // ‡πÅ‡∏¢‡∏Å‡∏î‡πâ‡∏ß‡∏¢ Tab (‡∏Å‡∏£‡∏ì‡∏µ Excel) ‡∏´‡∏£‡∏∑‡∏≠ Space
         let parts = line.split(/\t/); 
         if(parts.length < 2) parts = line.split(/ +/); // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ Tab ‡∏•‡∏≠‡∏á‡πÅ‡∏¢‡∏Å‡∏î‡πâ‡∏ß‡∏¢ Space
         
         if(parts.length >= 1) {
            let id = parts[0].trim();
            let name = parts.length > 1 ? parts[1].trim() : '-';
            if(id) newList.push({ id: id, name: name });
         }
      });

      if(newList.length === 0) { alert('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return; }
      if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${newList.length} ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠?\n(‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)`)) return;

      const btn = document.getElementById('btnSaveWhitelist');
      btn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...'; btn.disabled = true;

      fetch(SCRIPT_URL, {
         method: 'POST',
         body: JSON.stringify({ action: 'updateWhitelist', listData: newList })
      })
      .then(res => res.json())
      .then(json => {
         if(json.success) {
            alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
            renderWhitelist(newList); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤
            document.getElementById('whitelistInput').value = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á
         } else {
            alert('Error: ' + json.error);
         }
      })
      .finally(() => { btn.innerText = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°'; btn.disabled = false; });
    }

    function renderApplicants(data) {
       // ... (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£) ...
       const tbody = document.getElementById('adminTableBody');
       tbody.innerHTML = data.map(r => `
         <tr class="border-b">
           <td class="p-2">${new Date(r.timestamp).toLocaleDateString('th-TH')}</td>
           <td class="p-2">${r.idCard}</td>
           <td class="p-2">${r.name}</td>
           <td class="p-2"><a href="${r.pdfUrl}" target="_blank" class="text-blue-600">PDF</a></td>
         </tr>
       `).join('');
    }

    function submitForm(e) {
       // ... (‡πÇ‡∏Ñ‡πâ‡∏î submitForm ‡πÄ‡∏î‡∏¥‡∏°) ...
    }
  </script>
</body>
</html>
