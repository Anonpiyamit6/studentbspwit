<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Modern Import)</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
  
  <style>
    body { font-family: 'Sarabun', sans-serif; }
    .hidden { display: none !important; }

    /* Custom Input Style */
    .input-group label { display: block; font-weight: bold; margin-bottom: 5px; color: #1e3a8a; }
    .input-group input, .input-group select { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; transition: all 0.2s; }
    .input-group input:focus, .input-group select:focus { border-color: #2563eb; ring: 2px; outline: none; }
    .section-head { background: #e0f2fe; padding: 10px; font-weight: bold; color: #0c4a6e; border-left: 4px solid #0284c7; margin-top: 20px; margin-bottom: 10px; }

    /* Admin Tabs */
    .tab-btn { padding: 12px 24px; cursor: pointer; border-bottom: 3px solid transparent; font-weight: bold; color: #64748b; transition: all 0.2s; }
    .tab-btn.active { border-bottom-color: #1e3a8a; color: #1e3a8a; background: #f1f5f9; border-radius: 8px 8px 0 0; }
    
    /* Filters */
    .filter-btn { padding: 6px 16px; border-radius: 20px; border: 1px solid #ccc; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; }
    .filter-btn:hover { background-color: #f3f4f6; }
    .filter-btn.active { background-color: #1e3a8a; color: white; border-color: #1e3a8a; }

    /* --- ‚ú® New Import UI Styles --- */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in-up { animation: fadeInUp 0.4s ease-out forwards; }

    /* Custom Scrollbar for Table */
    .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* Drag & Drop State */
    .drag-active {
      background-color: #eff6ff !important; /* blue-50 */
      border-color: #3b82f6 !important; /* blue-500 */
      transform: scale(1.01);
      box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.1);
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">

  <div id="loginSection" class="min-h-screen flex flex-col md:flex-row">
    <div class="md:w-1/2 bg-blue-900 flex flex-col justify-center items-center text-white p-10 relative">
      <h1 class="text-4xl font-bold mb-4">‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
      <h2 class="text-2xl opacity-90">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡∏≤‡∏á‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</h2>
      <div class="mt-8 text-blue-200 text-center text-sm">
        <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</p>
      </div>
      <button onclick="toggleAdminLogin()" class="absolute bottom-4 left-4 text-blue-300 text-xs hover:text-white underline transition">
        ‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô / ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà)
      </button>
    </div>
    
    <div class="md:w-1/2 bg-white flex flex-col justify-center items-center p-8">
      <div class="w-full max-w-md">
        
        <div id="studentLoginBox" class="animate-fade-in-up">
          <div class="text-center mb-8">
            <h3 class="text-2xl font-bold text-gray-800">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</h3>
            <p class="text-gray-500 text-sm mt-1">‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô 13 ‡∏´‡∏•‡∏±‡∏Å</p>
          </div>
          <form onsubmit="handleLogin(event, 'student')" class="space-y-5">
            <div>
               <input type="text" id="loginIdCard" maxlength="13" required 
                      class="w-full p-4 border border-gray-300 rounded-xl text-2xl text-center tracking-[0.2em] font-mono focus:ring-4 focus:ring-blue-100 focus:border-blue-500 transition-all placeholder-gray-300" 
                      placeholder="0000000000000">
            </div>
            <button type="submit" id="btnLoginStudent" class="w-full bg-blue-900 text-white py-4 rounded-xl font-bold text-lg hover:bg-blue-800 shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1">
              ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
            </button>
          </form>
        </div>

        <div id="adminLoginBox" class="hidden animate-fade-in-up">
          <div class="text-center mb-8">
            <h3 class="text-2xl font-bold text-red-800">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà: ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3>
            <p class="text-gray-500 text-sm mt-1">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
          </div>
          <form onsubmit="handleLogin(event, 'admin')" class="space-y-4 border border-gray-100 p-6 rounded-2xl shadow-sm bg-white">
            <div>
               <label class="block font-bold text-gray-700 text-sm mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Username)</label>
               <input type="text" id="adminUser" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-red-100 focus:border-red-500" placeholder="admin">
            </div>
            <div>
               <label class="block font-bold text-gray-700 text-sm mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (Password)</label>
               <input type="password" id="adminPass" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-red-100 focus:border-red-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <button type="submit" id="btnLoginAdmin" class="w-full bg-red-800 text-white py-3 rounded-lg font-bold hover:bg-red-700 mt-2 shadow-md transition-all">
              ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö
            </button>
            <button type="button" onclick="toggleAdminLogin()" class="w-full text-gray-400 mt-4 text-xs hover:text-gray-600">
              ‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
            </button>
          </form>
        </div>

      </div>
    </div>
  </div>

  <div id="adminSection" class="hidden min-h-screen p-4 md:p-8 bg-gray-100">
    <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden min-h-[85vh] flex flex-col">
      <div class="bg-gray-800 text-white p-6 flex justify-between items-center">
        <div class="flex items-center gap-3">
           <div class="bg-gray-700 p-2 rounded-lg">‚öôÔ∏è</div>
           <div>
             <h2 class="text-xl font-bold">Admin Dashboard</h2>
             <p class="text-xs text-gray-400">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£</p>
           </div>
        </div>
        <button onclick="location.reload()" class="bg-red-600 hover:bg-red-700 px-5 py-2 rounded-lg text-sm font-bold transition-colors">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>

      <div class="flex border-b bg-gray-50 px-6 pt-4 gap-4">
        <div onclick="switchTab('applicants')" id="tab-applicants" class="tab-btn active">üìÑ ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£</div>
        <div onclick="switchTab('import')" id="tab-import" class="tab-btn">üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Excel)</div>
      </div>

      <div id="view-applicants" class="p-8 flex-grow">
        <div class="flex flex-wrap justify-between items-center mb-6">
          <h3 class="font-bold text-xl text-gray-800">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</h3>
          <div class="flex gap-2">
             <button onclick="applyFilter('all')" class="filter-btn active" id="filter-all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
             <button onclick="applyFilter('M1')" class="filter-btn" id="filter-M1">‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‡∏°.1</button>
             <button onclick="applyFilter('M4')" class="filter-btn" id="filter-M4">‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‡∏°.4</button>
          </div>
        </div>
        
        <div class="overflow-hidden border border-gray-200 rounded-xl shadow-sm">
          <table class="w-full text-left border-collapse">
            <thead class="bg-blue-50 text-blue-900 uppercase text-xs font-bold tracking-wider">
              <tr>
                <th class="p-4 border-b">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</th>
                <th class="p-4 border-b">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</th>
                <th class="p-4 border-b">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                <th class="p-4 border-b text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
              </tr>
            </thead>
            <tbody id="adminTableBody" class="bg-white text-sm divide-y divide-gray-100">
              </tbody>
          </table>
        </div>
      </div>

      <div id="view-import" class="p-8 hidden flex-grow bg-gray-50">
        <div class="max-w-4xl mx-auto">
          
          <div class="text-center mb-8">
            <h2 class="text-2xl font-bold text-gray-800">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (Whitelist)</h2>
            <p class="text-gray-500 text-sm mt-1">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Excel (.xlsx) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</p>
          </div>

          <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 mb-6">
            <div 
              id="dropZone"
              class="relative border-2 border-dashed border-blue-300 rounded-xl p-10 text-center hover:bg-blue-50 transition-all duration-300 group cursor-pointer"
              onclick="document.getElementById('excelFile').click()"
              ondragover="handleDragOver(event)"
              ondragleave="handleDragLeave(event)"
              ondrop="handleDrop(event)"
            >
              <input type="file" id="excelFile" class="hidden" accept=".xlsx, .xls" onchange="handleFileUpload(event)">
              <div class="flex flex-col items-center justify-center space-y-4">
                <div class="bg-blue-100 p-4 rounded-full group-hover:scale-110 transition-transform">
                   <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                </div>
                <div>
                  <p class="text-lg font-semibold text-gray-700">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå ‡∏´‡∏£‡∏∑‡∏≠ ‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
                  <p class="text-sm text-gray-400 mt-1">‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå A=‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£, B=‡∏ä‡∏∑‡πà‡∏≠</p>
                </div>
              </div>
            </div>
          </div>

          <div id="previewSection" class="hidden animate-fade-in-up">
            <div class="flex justify-between items-end mb-3 px-1">
               <h3 class="font-bold text-gray-700 flex items-center gap-2">
                 ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• <span id="previewCountBadge" class="bg-green-100 text-green-800 text-xs px-2 py-0.5 rounded-full">0</span>
               </h3>
               <button onclick="clearImport()" class="text-xs text-red-500 hover:underline">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button>
            </div>
            
            <div class="bg-white border rounded-xl shadow-lg overflow-hidden flex flex-col h-[400px]">
               <div class="overflow-y-auto flex-grow custom-scrollbar">
                 <table class="w-full text-left border-collapse">
                   <thead class="bg-gray-100 sticky top-0 z-10 shadow-sm">
                     <tr>
                       <th class="p-3 text-xs font-bold text-gray-500 w-16 text-center">#</th>
                       <th class="p-3 text-xs font-bold text-gray-500">ID Card</th>
                       <th class="p-3 text-xs font-bold text-gray-500">Name</th>
                       <th class="p-3 text-xs font-bold text-gray-500 text-center w-20">Status</th>
                     </tr>
                   </thead>
                   <tbody id="previewTableBody" class="divide-y divide-gray-100 text-sm"></tbody>
                 </table>
               </div>
               <div class="bg-gray-50 p-4 border-t flex justify-between items-center">
                 <span class="text-xs text-gray-400">* ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                 <button id="btnConfirmImport" onclick="confirmImport()" class="bg-green-600 text-white px-6 py-2.5 rounded-lg font-bold shadow hover:bg-green-700 transition transform hover:-translate-y-0.5">
                    ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤
                 </button>
               </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <div id="formSection" class="hidden p-4 md:p-8 max-w-5xl mx-auto">
    <div class="bg-white p-6 md:p-10 rounded-2xl shadow-2xl relative border border-gray-200">
      
      <div id="adminEditHeader" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-8 flex justify-between items-center">
        <div class="flex items-center gap-3">
           <div class="bg-yellow-100 p-2 rounded-full text-yellow-600">üìù</div>
           <div>
              <p class="font-bold text-yellow-800">‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Admin)</p>
              <p class="text-sm text-yellow-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: <span id="editingName" class="font-bold underline">-</span></p>
           </div>
        </div>
        <button onclick="closeAdminEdit()" class="bg-white border border-gray-300 text-gray-600 px-4 py-2 rounded-lg text-sm hover:bg-gray-50 font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å / ‡∏Å‡∏•‡∏±‡∏ö</button>
      </div>

      <div class="flex justify-between items-center mb-8 pb-4 border-b">
        <div>
           <h2 class="text-3xl font-bold text-blue-900">‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</h2>
           <p class="text-gray-500 mt-1">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡∏≤‡∏á‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</p>
        </div>
        <button id="btnStudentLogout" onclick="location.reload()" class="text-red-500 hover:text-red-700 font-medium text-sm flex items-center gap-1">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
          ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
        </button>
      </div>

      <form id="appForm" onsubmit="submitForm(event)">
        <div class="bg-blue-50 p-6 rounded-xl mb-8 border border-blue-100">
           <label class="font-bold text-xl text-blue-900 mb-3 block">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</label>
           <div class="relative">
             <select id="applyLevel" class="w-full md:w-1/3 p-3 pl-4 border border-blue-200 rounded-lg text-lg font-bold text-blue-800 bg-white focus:ring-2 focus:ring-blue-400 outline-none appearance-none" required>
                <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
                <option value="‡∏°.1">‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 1</option>
                <option value="‡∏°.4">‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 4</option>
             </select>
             <div class="pointer-events-none absolute inset-y-0 left-[30%] flex items-center px-2 text-gray-700">‚ñº</div>
           </div>
        </div>

        <div class="section-head rounded">1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£</div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-6">
          <div class="input-group"><label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</label><select id="serviceArea"><option>‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Ç‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</option><option>‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</option></select></div>
          <div class="input-group"><label>‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label><select id="program"><option>‡∏ß‡∏¥‡∏ó‡∏¢‡πå-‡∏Ñ‡∏ì‡∏¥‡∏ï</option><option>‡∏®‡∏¥‡∏•‡∏õ‡πå-‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</option><option>‡∏®‡∏¥‡∏•‡∏õ‡πå-‡∏†‡∏≤‡∏©‡∏≤</option><option>‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option></select></div>
          <div class="input-group md:col-span-2"><label>‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏î‡∏¥‡∏°</label><input type="text" id="oldSchool" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏ö‡∏°‡∏≤"></div>
        </div>

        <div class="section-head rounded">2. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-5 mb-8">
           <div class="input-group md:col-span-2"><label>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label><input id="idCard" readonly class="bg-gray-100 text-gray-500 cursor-not-allowed font-mono tracking-wider"></div>
           <div class="input-group"><label>‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</label><select id="prefix"><option>‡∏î.‡∏ä.</option><option>‡∏î.‡∏ç.</option><option>‡∏ô‡∏≤‡∏¢</option><option>‡∏ô.‡∏™.</option></select></div>
           <div class="input-group"><label>‡∏ä‡∏∑‡πà‡∏≠</label><input id="name"></div>
           <div class="input-group"><label>‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input id="surname"></div>
           <div class="input-group"><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input id="phoneReg"></div>
           </div>

        <div class="flex gap-4 pt-4 border-t">
           <button type="submit" id="btnSubmit" class="flex-1 bg-blue-900 text-white font-bold py-4 rounded-xl hover:bg-blue-800 text-xl shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1">
             ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
           </button>
           
           <a id="btnDownloadPDF" href="#" target="_blank" class="hidden flex-1 bg-green-600 text-white font-bold py-4 rounded-xl hover:bg-green-700 text-xl shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1 text-center flex items-center justify-center gap-2">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
              ‡∏û‡∏¥‡∏°‡∏û‡πå PDF
           </a>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ==========================================
    // üî¥üî¥ ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ üî¥üî¥
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxtWZwXSFcbdrrPZSLrs4kmEDYB4fqx3MxUs0Wo40lgkAyIi_6C-j0AJ3YZgWOBJ16AHw/exec'; 
    // ==========================================

    let allApplicants = [];
    let isAdminMode = false;
    let tempImportData = [];

    // --- UTILS ---
    function toggleAdminLogin() {
      document.getElementById('studentLoginBox').classList.toggle('hidden');
      document.getElementById('adminLoginBox').classList.toggle('hidden');
    }
    function switchTab(tabName) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById('view-applicants').classList.add('hidden');
      document.getElementById('view-import').classList.add('hidden');
      document.getElementById('tab-' + tabName).classList.add('active');
      document.getElementById('view-' + tabName).classList.remove('hidden');
    }

    // --- LOGIN ---
    function handleLogin(e, role) {
      e.preventDefault();
      let payload = { action: 'login' };
      let btn;
      
      if (role === 'student') {
        payload.username = document.getElementById('loginIdCard').value;
        payload.password = '';
        btn = document.getElementById('btnLoginStudent');
      } else {
        payload.username = document.getElementById('adminUser').value;
        payload.password = document.getElementById('adminPass').value;
        btn = document.getElementById('btnLoginAdmin');
      }

      if(!payload.username) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'); return; }
      
      const originalText = btn.innerText;
      btn.innerText = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...'; btn.disabled = true;

      fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) })
      .then(res => res.json())
      .then(json => {
         if (json.error) { alert('‚ùå ' + json.error); } 
         else {
            document.getElementById('loginSection').classList.add('hidden');
            if (json.role === 'admin') {
               document.getElementById('adminSection').classList.remove('hidden');
               allApplicants = json.data;
               renderApplicants(allApplicants);
            } else {
               isAdminMode = false;
               document.getElementById('formSection').classList.remove('hidden');
               document.getElementById('idCard').value = payload.username;
               if(json.found) populateForm(json.data);
            }
         }
      })
      .catch(err => alert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ' + err))
      .finally(() => { btn.innerText = originalText; btn.disabled = false; });
    }

    // --- ADMIN FILTER ---
    function applyFilter(level) {
       document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
       document.getElementById('filter-' + level).classList.add('active');
       if (level === 'all') renderApplicants(allApplicants);
       else renderApplicants(allApplicants.filter(item => item.level === level));
    }

    function renderApplicants(data) {
       const tbody = document.getElementById('adminTableBody');
       tbody.innerHTML = '';
       if(!data.length) { tbody.innerHTML = '<tr><td colspan="4" class="p-6 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</td></tr>'; return; }
       
       data.forEach((r, index) => {
         tbody.innerHTML += `
           <tr class="hover:bg-blue-50 transition border-b last:border-0">
             <td class="p-4"><span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-bold">${r.level}</span></td>
             <td class="p-4 font-mono text-gray-700">${r.idCard}</td>
             <td class="p-4 font-bold text-gray-800">${r.name}</td>
             <td class="p-4 text-center">
                <button onclick="openAdminEdit(${index})" class="bg-white border border-yellow-400 text-yellow-600 px-3 py-1 rounded-lg text-sm hover:bg-yellow-50 shadow-sm font-bold transition">
                   üìù ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                </button>
             </td>
           </tr>
         `;
       });
    }

    // --- üü¢ NEW DRAG & DROP IMPORT ---
    function handleDragOver(e) { e.preventDefault(); document.getElementById('dropZone').classList.add('drag-active'); }
    function handleDragLeave(e) { e.preventDefault(); document.getElementById('dropZone').classList.remove('drag-active'); }
    function handleDrop(e) {
      e.preventDefault();
      document.getElementById('dropZone').classList.remove('drag-active');
      if (e.dataTransfer.files.length > 0) processFile(e.dataTransfer.files[0]);
    }
    function handleFileUpload(event) { if (event.target.files[0]) processFile(event.target.files[0]); }

    function processFile(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1});
        
        tempImportData = [];
        jsonData.forEach(row => {
            let id = row[0] ? String(row[0]).trim() : '';
            let name = row[1] ? String(row[1]).trim() : '';
            if (id.length >= 5 && !id.toLowerCase().includes('id')) { 
               tempImportData.push({ id: id, name: name });
            }
        });
        renderNewPreview();
      };
      reader.readAsArrayBuffer(file);
    }

    function renderNewPreview() {
      const previewSection = document.getElementById('previewSection');
      const tbody = document.getElementById('previewTableBody');
      const countBadge = document.getElementById('previewCountBadge');
      
      previewSection.classList.remove('hidden');
      countBadge.innerText = tempImportData.length;
      tbody.innerHTML = '';

      if (tempImportData.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" class="p-8 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå</td></tr>`;
        document.getElementById('btnConfirmImport').classList.add('opacity-50', 'pointer-events-none');
        return;
      }

      document.getElementById('btnConfirmImport').classList.remove('opacity-50', 'pointer-events-none');
      
      const displayLimit = tempImportData.slice(0, 100); 
      displayLimit.forEach((item, idx) => {
        tbody.innerHTML += `
          <tr class="hover:bg-blue-50 border-b">
            <td class="p-3 text-center text-gray-400 font-mono text-xs">${idx + 1}</td>
            <td class="p-3 font-mono font-bold text-blue-700">${item.id}</td>
            <td class="p-3 text-gray-700">${item.name || '-'}</td>
            <td class="p-3 text-center"><span class="text-xs font-bold text-green-600 bg-green-100 px-2 py-0.5 rounded-full">OK</span></td>
          </tr>
        `;
      });
      if(tempImportData.length > 100) tbody.innerHTML += `<tr><td colspan="4" class="p-3 text-center text-xs text-gray-500 bg-gray-50">...‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${tempImportData.length-100} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...</td></tr>`;
    }

    function clearImport() {
       document.getElementById('excelFile').value = '';
       document.getElementById('previewSection').classList.add('hidden');
       tempImportData = [];
    }

    function confirmImport() {
      if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ${tempImportData.length} ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠?\n(‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πà‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡πâ‡∏≤‡∏á)`)) return;
      const btn = document.getElementById('btnConfirmImport');
      btn.innerText = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...';
      
      fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'updateWhitelist', listData: tempImportData }) })
      .then(res => res.json())
      .then(json => {
         if(json.success) { alert('‚úÖ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); clearImport(); }
         else alert('Error: ' + json.error);
      })
      .finally(() => btn.innerText = '‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤');
    }

    // --- FORM LOGIC ---
    function openAdminEdit(index) {
       isAdminMode = true;
       const data = allApplicants[index].fullData;
       
       document.getElementById('adminSection').classList.add('hidden');
       document.getElementById('formSection').classList.remove('hidden');
       document.getElementById('adminEditHeader').classList.remove('hidden');
       document.getElementById('editingName').innerText = data.prefix + data.name + " " + data.surname;
       document.getElementById('btnStudentLogout').classList.add('hidden');
       
       const btnSub = document.getElementById('btnSubmit');
       btnSub.innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Admin)";
       btnSub.className = "flex-1 bg-yellow-500 text-white font-bold py-4 rounded-xl hover:bg-yellow-600 text-xl shadow-lg";

       populateForm(data);

       const btnPDF = document.getElementById('btnDownloadPDF');
       if (allApplicants[index].pdfUrl) {
          btnPDF.href = allApplicants[index].pdfUrl;
          btnPDF.classList.remove('hidden');
       } else btnPDF.classList.add('hidden');
    }

    function closeAdminEdit() {
       document.getElementById('appForm').reset();
       document.getElementById('formSection').classList.add('hidden');
       document.getElementById('adminSection').classList.remove('hidden');
       document.getElementById('adminEditHeader').classList.add('hidden');
    }

    function populateForm(data) {
       for (const key in data) {
          const el = document.getElementById(key);
          if (el && el.type !== 'checkbox') el.value = data[key];
       }
    }

    function submitForm(e) {
      e.preventDefault();
      const btn = document.getElementById('btnSubmit');
      btn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...'; btn.disabled = true;

      let data = {};
      document.querySelectorAll('#appForm input:not([type="checkbox"]), #appForm select').forEach(el => data[el.id] = el.value);

      fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'save', data: data }) })
      .then(res => res.json())
      .then(json => {
         if(json.success) {
            alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            if (isAdminMode) {
               const btnPDF = document.getElementById('btnDownloadPDF');
               btnPDF.href = json.url;
               btnPDF.classList.remove('hidden');
            } else window.location.href = json.url;
         } else alert('Error: ' + json.error);
      })
      .finally(() => { 
         btn.innerText = isAdminMode ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Admin)' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'; 
         btn.disabled = false; 
      });
    }
  </script>
</body>
</html>
