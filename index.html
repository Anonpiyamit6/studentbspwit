<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Sarabun', sans-serif; }
    .hidden { display: none !important; }
    /* Animations */
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in-up { animation: fadeInUp 0.4s ease-out forwards; }
    .drag-active { background-color: #eff6ff !important; border-color: #3b82f6 !important; transform: scale(1.01); }
    /* Tabs */
    .tab-btn { padding: 12px; cursor: pointer; border-bottom: 3px solid transparent; color: #64748b; font-weight: bold; }
    .tab-btn.active { border-bottom-color: #1e3a8a; color: #1e3a8a; background: #f8fafc; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans">

  <div id="loginSection" class="min-h-screen flex flex-col md:flex-row">
    <div class="md:w-1/2 bg-blue-900 flex items-center justify-center text-white p-10 relative">
      <div><h1 class="text-4xl font-bold">‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1><p class="mt-2 text-blue-200">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡∏≤‡∏á‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</p></div>
      <button onclick="toggleLogin()" class="absolute bottom-5 left-5 text-xs text-blue-300 underline">‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</button>
    </div>
    <div class="md:w-1/2 bg-white flex items-center justify-center p-8">
      <div class="w-full max-w-md">
        <div id="boxStudent">
           <h2 class="text-2xl font-bold text-center mb-6">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</h2>
           <form onsubmit="doLogin(event, 'student')" class="space-y-4">
             <input id="stuId" class="w-full p-4 border rounded-xl text-center text-xl font-mono tracking-widest" placeholder="‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô" required>
             <button id="btnStu" type="submit" class="w-full bg-blue-900 text-white py-3 rounded-xl font-bold shadow-lg">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
           </form>
        </div>
        <div id="boxAdmin" class="hidden">
           <h2 class="text-2xl font-bold text-center mb-6 text-red-800">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà: ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
           <form onsubmit="doLogin(event, 'admin')" class="space-y-4">
             <input id="admUser" class="w-full p-3 border rounded" placeholder="Username">
             <input id="admPass" type="password" class="w-full p-3 border rounded" placeholder="Password">
             <button id="btnAdm" type="submit" class="w-full bg-red-800 text-white py-3 rounded font-bold shadow-lg">Login</button>
           </form>
        </div>
      </div>
    </div>
  </div>

  <div id="adminSection" class="hidden p-6">
    <div class="max-w-6xl mx-auto bg-white rounded-xl shadow-xl overflow-hidden min-h-[80vh]">
       <div class="bg-gray-800 text-white p-4 flex justify-between items-center">
         <h2 class="font-bold text-xl">‚öôÔ∏è Admin Dashboard</h2>
         <button onclick="location.reload()" class="text-red-300 text-sm">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
       </div>
       
       <div class="flex border-b bg-gray-50">
         <div onclick="setTab('list')" id="tab-list" class="tab-btn active w-1/3 text-center">üìÑ ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£</div>
         <div onclick="setTab('add')" id="tab-add" class="tab-btn w-1/3 text-center">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏£‡∏≤‡∏¢‡∏Ñ‡∏ô</div>
         <div onclick="setTab('import')" id="tab-import" class="tab-btn w-1/3 text-center">üì• Import Excel</div>
       </div>

       <div id="view-list" class="p-6">
         <div id="tableContainer" class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="bg-gray-100 uppercase"><tr><th class="p-3">Level</th><th class="p-3">ID</th><th class="p-3">Name</th><th class="p-3">Action</th></tr></thead><tbody id="tbodyList"></tbody></table></div>
       </div>

       <div id="view-add" class="p-8 hidden bg-gray-50 h-full">
         <div class="max-w-md mx-auto bg-white p-8 rounded-xl shadow border">
           <h3 class="text-xl font-bold text-center mb-6">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</h3>
           <form onsubmit="addSingle(event)" class="space-y-4">
             <div><label class="block font-bold text-sm mb-1">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label><input id="addId" class="w-full p-3 border rounded font-mono" required maxlength="13"></div>
             <div><label class="block font-bold text-sm mb-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</label><input id="addName" class="w-full p-3 border rounded" required></div>
             <button id="btnAddSingle" type="submit" class="w-full bg-green-600 text-white py-3 rounded font-bold shadow hover:bg-green-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
           </form>
         </div>
       </div>

       <div id="view-import" class="p-8 hidden">
         <div class="border-2 border-dashed border-blue-300 rounded-xl p-10 text-center cursor-pointer hover:bg-blue-50" onclick="document.getElementById('fileIn').click()">
            <input type="file" id="fileIn" class="hidden" onchange="readExcel(this)">
            <p class="text-xl font-bold text-blue-800">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏´‡∏£‡∏∑‡∏≠ ‡∏•‡∏≤‡∏Å‡∏ß‡∏≤‡∏á</p>
            <p class="text-sm text-gray-400 mt-2">Column A=ID, B=Name</p>
         </div>
         <div id="previewArea" class="hidden mt-6">
           <p class="font-bold mb-2">‡∏û‡∏ö <span id="countPreview">0</span> ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</p>
           <button onclick="runImport()" id="btnImport" class="bg-blue-900 text-white px-6 py-2 rounded shadow">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ (‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤)</button>
         </div>
       </div>
    </div>
  </div>

  <div id="formSection" class="hidden p-6"><div class="max-w-4xl mx-auto bg-white p-8 rounded shadow"><h2 class="text-2xl font-bold mb-4">‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</h2><form id="appForm" onsubmit="saveForm(event)"><button class="bg-blue-900 text-white p-3 rounded w-full">‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</button></form></div></div>

  <script>
    // ==========================================
    // üî¥üî¥ ‡πÉ‡∏™‡πà URL ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà Deploy ‡πÅ‡∏•‡πâ‡∏ß ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ üî¥üî¥
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxtWZwXSFcbdrrPZSLrs4kmEDYB4fqx3MxUs0Wo40lgkAyIi_6C-j0AJ3YZgWOBJ16AHw/exec'; 
    // ==========================================

    let rawData = [];
    let importData = [];

    function toggleLogin() { document.getElementById('boxStudent').classList.toggle('hidden'); document.getElementById('boxAdmin').classList.toggle('hidden'); }
    function setTab(t) { 
      ['list','add','import'].forEach(x => { document.getElementById('view-'+x).classList.add('hidden'); document.getElementById('tab-'+x).classList.remove('active'); });
      document.getElementById('view-'+t).classList.remove('hidden'); document.getElementById('tab-'+t).classList.add('active');
    }

    function doLogin(e, role) {
      e.preventDefault();
      const u = role==='student'? document.getElementById('stuId').value : document.getElementById('admUser').value;
      const p = role==='student'? '' : document.getElementById('admPass').value;
      const btn = role==='student'? document.getElementById('btnStu') : document.getElementById('btnAdm');
      
      btn.innerText = 'Loading...'; btn.disabled = true;

      fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'login', username: u, password: p }) })
      .then(r => r.json())
      .then(res => {
        if(res.error) alert(res.error);
        else if(res.role === 'admin') {
          document.getElementById('loginSection').classList.add('hidden');
          document.getElementById('adminSection').classList.remove('hidden');
          renderList(res.data);
        } else {
          // Student logic here
          alert('Login Student Success (Form Hidden for short code)');
        }
      })
      .catch(err => alert('Error: ' + err))
      .finally(() => { btn.innerText = 'Login'; btn.disabled = false; });
    }

    // --- MAIN FUNCTION: ADD SINGLE ---
    function addSingle(e) {
      e.preventDefault();
      const id = document.getElementById('addId').value;
      const name = document.getElementById('addName').value;
      const btn = document.getElementById('btnAddSingle');
      
      btn.innerText = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...'; btn.disabled = true;

      // Log ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏™‡πà‡∏á‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏õ
      console.log("Sending to:", SCRIPT_URL);

      fetch(SCRIPT_URL, {
        method: 'POST',
        // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô Stringify JSON
        body: JSON.stringify({ 
          action: 'appendWhitelist', 
          data: { id: id, name: name } 
        })
      })
      .then(response => {
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ Server ‡∏ï‡∏≠‡∏ö 200 OK ‡πÑ‡∏´‡∏°
        if (!response.ok) throw new Error("HTTP Status " + response.status);
        return response.json();
      })
      .then(json => {
        if (json.success) {
          alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
          document.getElementById('addId').value = '';
          document.getElementById('addName').value = '';
        } else {
          alert('‚ùå Server ‡πÅ‡∏à‡πâ‡∏á‡∏ß‡πà‡∏≤: ' + json.error);
        }
      })
      .catch(error => {
        console.error("Fetch Error:", error);
        alert('‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß (Failed to fetch)\n1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Deploy New Version ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á\n2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL\nDetail: ' + error);
      })
      .finally(() => {
        btn.innerText = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'; btn.disabled = false;
      });
    }

    function renderList(data) {
      const tb = document.getElementById('tbodyList'); tb.innerHTML = '';
      data.forEach(r => tb.innerHTML += `<tr class="border-b"><td class="p-2">${r.level}</td><td class="p-2 font-mono">${r.idCard}</td><td class="p-2">${r.name}</td><td class="p-2"><button class="text-blue-600">Edit</button></td></tr>`);
    }

    // Import Logic (Simplified)
    function readExcel(inpt) {
       const f = inpt.files[0]; const r = new FileReader();
       r.onload = (e) => {
         const wb = XLSX.read(e.target.result, {type:'array'});
         const arr = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
         importData = arr.map(r => ({id: r[0], name: r[1]})).filter(x => x.id);
         document.getElementById('previewArea').classList.remove('hidden');
         document.getElementById('countPreview').innerText = importData.length;
       };
       r.readAsArrayBuffer(f);
    }
    function runImport() {
       if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô?')) return;
       fetch(SCRIPT_URL, {method:'POST', body:JSON.stringify({action:'updateWhitelist', listData:importData})})
       .then(r=>r.json()).then(j=>{ alert(j.success?'OK':'Err'); location.reload(); });
    }
  </script>
</body>
</html>
